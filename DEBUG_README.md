# CookieSyncer 调试指南

## 问题描述

用户报告了两个主要问题：
1. **Cookie查看器显示数量0**：无法看到任何Cookie信息
2. **刷新频率无法设置**：在设置页面更改推送频率后，定时任务没有更新

## 问题原因分析

经过代码审查，发现了以下潜在问题：

### 1. Chrome Cookie API错误处理不足
- `chrome.cookies.getAll()` 调用没有正确处理错误情况
- 在Manifest V3中，一些API调用需要更好的错误处理

### 2. 异步流程问题
- background.js使用老式的回调风格，可能导致竞态条件
- 消息传递机制可能存在时序问题

### 3. 域名配置验证缺失
- 获取Cookie时没有验证域名是否真的存在配置
- 错误响应处理不够详细

## 修复措施

### 1. 修复background.js
- **增强错误处理**：为`chrome.cookies.getAll()`添加完整的错误检查
- **域名验证**：在获取Cookie前验证域名配置是否存在
- **调试日志**：添加详细的日志记录便于问题定位

### 2. 修复cookies.js
- **响应验证**：增强对background.js响应的验证和错误处理
- **配置处理**：确保域名配置的必要字段都存在默认值

### 3. 修复options.js
- **消息调试**：添加更详细的消息传递日志
- **状态反馈**：改善定时任务更新的反馈信息

## 测试工具使用方法

### 方法1：在扩展页面中运行测试
1. 打开浏览器的扩展管理页面（`chrome://extensions/`）
2. 找到CookieSyncer扩展，点击"详情"
3. 在扩展详情页面中，有一个"扩展选项"按钮，点击进入设置页面
4. 在设置页面的控制台中粘贴以下代码并运行：

```javascript
// 复制test-debug.js中的内容到控制台并执行
```

### 方法2：使用调试脚本文件
1. 将`test-debug.js`文件的内容复制到浏览器的控制台
2. 运行代码进行全面测试

## 测试项目说明

调试工具会运行以下5个测试项目：

### 1. Extension Loaded（扩展加载测试）
- 检查扩展是否正确加载
- 验证manifest权限配置

### 2. Storage（存储测试）
- 检查Chrome存储中的域名配置数据
- 验证数据格式是否正确

### 3. Domain Configs（域名配置测试）
- 通过消息传递获取域名配置
- 验证配置数据的完整性

### 4. Cookie Fetching（Cookie获取测试）
- 测试从指定域名获取Cookie的功能
- 检查API调用和错误处理

### 5. Alarms（定时任务测试）
- 检查定时任务是否正确创建
- 验证定时任务配置是否正确

## 预期结果

修复后，您应该看到：

1. **Cookie查看器能正确显示Cookie数量**
2. **设置页面能正确更新推送频率**
3. **定时任务按新的频率正确执行**
4. **调试工具显示所有测试通过**

## 故障排除

如果问题仍然存在，请检查：

1. **权限问题**：
   - 确保扩展有`cookies`权限
   - 检查`host_permissions`是否包含目标域名

2. **域名配置问题**：
   - 确认域名格式正确（不包含协议头）
   - 检查域名是否已启用

3. **浏览器兼容性**：
   - 确保使用Chrome 88或更高版本
   - 检查是否在隐私浏览模式下运行

## 技术支持

如果问题持续存在，请：
1. 运行调试工具获取详细错误信息
2. 检查浏览器控制台的错误日志
3. 确认扩展权限和设置

## 更新日志

- **修复1**：增强Chrome Cookie API错误处理
- **修复2**：改进异步消息传递机制
- **修复3**：添加域名配置验证
- **工具**：新增综合调试测试工具
